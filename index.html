<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Superlativos: Argentina</title>
    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cargar html2canvas para la captura de pantalla -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            /* Evita que toda la página se mueva en táctil */
            touch-action: manipulation;
        }
        .draggable {
            /* Habilita el arrastre táctil (touch) y con mouse */
            touch-action: none; 
            cursor: move;
        }
        .drop-slot {
            border: 2px dashed #9ca3af; /* gray-400 */
        }
        /* Estilo para resaltar al arrastrar por encima (táctil o mouse) */
        .drop-slot.drag-over {
            background-color: #dbeafe; /* blue-100 */
            border-color: #2563eb; /* blue-600 */
        }
        .drop-slot.correct {
            border: 2px solid #10b981; /* green-500 */
            background-color: #d1fae5; /* green-100 */
            color: #047857; /* green-800 */
            font-weight: 600;
        }
        .draggable.selected {
            /* Estilo para la pieza que se está arrastrando */
            background-color: #2563eb; /* blue-600 */
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        /* Ocultar elementos */
        .hidden {
            display: none;
        }
        /* Estilo para las opciones de radio */
        .radio-option:has(input:checked) {
            background-color: #eff6ff; /* blue-50 */
            border-color: #3b82f6; /* blue-500 */
        }
        /* Estilo para respuestas incorrectas */
        .question-card.incorrect {
            border-color: #ef4444; /* red-500 */
            background-color: #fee2e2; /* red-100 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen p-2 sm:p-4">

    <div id="game-container" class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8 transition-all duration-300 mx-auto">

        <!-- Pantalla 1: Ingresar Nombre -->
        <div id="name-screen">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-center text-blue-700 mb-6">Superlativos de Argentina</h1>
            <p class="text-center text-lg text-gray-600 mb-8">¡Vamos a practicar los superlativos relativos y absolutos!</p>
            <div class="flex flex-col items-center">
                <label for="player-name" class="text-lg font-medium text-gray-700 mb-2">Escribe tu nombre:</label>
                <input type="text" id="player-name" class="w-full max-w-sm text-center text-lg px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tu nombre">
                <button id="start-game-btn" class="w-full max-w-sm mt-6 px-6 py-3 bg-blue-600 text-white text-lg sm:text-xl font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform duration-150 active:scale-95">
                    ¡Empezar!
                </button>
            </div>
        </div>

        <!-- Pantalla 2: Superlativos Relativos (Arrastrar y Soltar) -->
        <div id="relative-screen" class="hidden">
            <h2 class="text-2xl font-bold text-blue-700 mb-2">Parte 1: Superlativos Relativos</h2>
            <p class="text-lg text-gray-600 mb-4">Ordena las palabras para formar una oración lógica.</p>
            
            <div class="flex justify-between items-center mb-4">
                <span id="relative-progress" class="text-lg font-medium text-gray-700">Oración 1 de 6</span>
                <span id="relative-timer" class="text-lg font-medium text-gray-700">Tiempo: 00:00</span>
            </div>

            <div id="sentence-puzzle">
                <!-- Los slots para soltar las palabras -->
                <div id="drop-container" class="flex flex-wrap gap-2 p-4 bg-gray-50 rounded-lg min-h-[100px] items-center justify-center">
                    <!-- Los slots se generan dinámicamente -->
                </div>

                <!-- Las palabras para arrastrar -->
                <div id="drag-container" class="flex flex-wrap gap-3 p-4 mt-6 min-h-[100px] items-center justify-center bg-gray-50 rounded-lg">
                    <!-- Las palabras se generan dinámicamente -->
                </div>
            </div>

            <button id="next-sentence-btn" class="w-full mt-6 px-6 py-3 bg-green-600 text-white text-lg sm:text-xl font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-transform duration-150 active:scale-95 hidden">
                ¡Correcto! Siguiente
            </button>
        </div>

        <!-- Pantalla 3: Superlativos Absolutos (Opción Múltiple) -->
        <div id="absolute-screen" class="hidden">
            <h2 class="text-2xl font-bold text-blue-700 mb-2">Parte 2: Superlativos Absolutos</h2>
            <p class="text-lg text-gray-600 mb-6">Elige la forma correcta del superlativo (–ísimo).</p>

            <div id="absolute-questions-container" class="space-y-6">
                <!-- Las preguntas se generan dinámicamente -->
            </div>

            <button id="submit-absolute-btn" class="w-full mt-8 px-6 py-3 bg-blue-600 text-white text-lg sm:text-xl font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform duration-150 active:scale-95">
                Revisar respuestas
            </button>
        </div>

        <!-- Pantalla 4: ¡Felicidades! -->
        <div id="success-screen" class="hidden text-center">
            <h1 id="success-message" class="text-2xl sm:text-3xl md:text-4xl font-bold text-green-600 mb-6">¡Felicidades, !</h1>
            <p class="text-xl text-gray-700 mb-4">¡Completaste la actividad!</p>
            <p id="final-time" class="text-2xl font-semibold text-blue-700 mb-8">Tiempo total: 00:00</p>
            
            <button id="screenshot-btn" class="w-full max-w-sm px-6 py-3 bg-indigo-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-transform duration-150 active:scale-95">
                Take a Screenshot to show your teacher you completed the activity
            </button>
            <p id="screenshot-feedback" class="text-sm text-gray-500 mt-4"></p>

            <button id="restart-game-btn" class="w-full max-w-sm mt-4 px-6 py-3 bg-gray-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-transform duration-150 active:scale-95">
                Jugar de nuevo
            </button>
        </div>
    </div>

    <script>
        // --- POOL DE PREGUNTAS (Relativas MODIFICADAS) ---

        const allRelativeSentences = [
            // Pool Original (9)
            { id: 1, parts: ["El río Paraná", "es", "el río", "más ancho", "de Argentina."] },
            { id: 2, parts: ["Buenos Aires", "es", "la ciudad", "más grande", "de Argentina."] },
            { id: 3, parts: ["Lionel Messi", "es", "el mejor", "jugador", "de fútbol", "de Argentina."] },
            { id: 4, parts: ["El Aconcagua", "es", "la montaña", "más alta", "del hemisferio sur."] },
            { id: 5, parts: ["El asado", "es", "el mejor", "plato", "de Argentina."] },
            { id: 6, parts: ["El Perito Moreno", "es", "el glaciar", "más visitado", "de Argentina."] },
            { id: 7, parts: ["La contaminación", "es", "la peor", "consecuencia", "del turismo."] },
            { id: 8, parts: ["Los meses", "de verano", "son", "los más", "calurosos", "en Argentina."] },
            { id: 9, parts: ["El tango", "es", "el baile", "más famoso", "de Buenos Aires."] },
            
            // Pool Añadido (9) - MODIFICADO PARA MÁS VARIEDAD
            { id: 10, parts: ["Las Cataratas del Iguazú", "son", "las cataratas", "más impresionantes", "del mundo."] },
            { id: 11, parts: ["La Boca", "es", "el barrio", "más colorido", "de Buenos Aires."] },
            { id: 12, parts: ["Ushuaia", "es", "la ciudad", "más austral", "del mundo."] },
            // CAMBIADO: 'más famosos' -> 'mejores'
            { id: 13, parts: ["Los gauchos", "son", "los mejores", "jinetes", "de Argentina."] }, 
            // CAMBIADO: 'más popular' -> 'mejor'
            { id: 14, parts: ["El mate", "es", "la mejor", "bebida", "para compartir."] }, 
            { id: 15, parts: ["La Patagonia", "es", "la región", "menos poblada", "del país."] }, // (Ya era 'menos')
            // CAMBIADO: 'más exportado' -> 'peor'
            { id: 16, parts: ["El Malbec", "es", "el peor", "vino", "para beber", "con pescado."] }, 
            // CAMBIADO: 'más importante' -> 'peor'
            { id: 17, parts: ["La burocracia", "es", "la peor", "parte", "del gobierno."] }, 
            // CAMBIADO: 'más apasionado' -> 'menos popular'
            { id: 18, parts: ["El criquet", "es", "el deporte", "menos popular", "de Argentina."] } 
        ];

        // --- POOL DE PREGUNTAS (Absolutas sin cambios) ---
        const allAbsoluteQuestions = [
            // Núcleo de la lección
            {
                id: 1,
                sentence: "Los alfajores argentinos son...",
                base: "(rico)",
                options: [
                    { text: "riquísimos", correct: true },
                    { text: "ricísimos", correct: false, feedback: "¡Error de ortografía! La 'c' cambia a 'qu' delante de 'i'." },
                    { text: "ricísimo", correct: false, feedback: "Casi... pero 'alfajores' es plural." },
                    { text: "ricísimas", correct: false, feedback: "Casi... pero 'alfajores' es masculino." }
                ]
            },
            {
                id: 2,
                sentence: "El río Paraná es un río...",
                base: "(largo)",
                options: [
                    { text: "larguísimo", correct: true },
                    { text: "largísimo", correct: false, feedback: "¡Error de ortografía! La 'g' cambia a 'gu' delante de 'i'." },
                    { text: "larguísima", correct: false, feedback: "Casi... pero 'río' es masculino." },
                    { text: "largoísimo", correct: false, feedback: "¡Ojo! Solo se añade '-ísimo' a la raíz (con el cambio ortográfico)." }
                ]
            },
            {
                id: 3,
                sentence: "Los pingüinos de la Patagonia son...",
                base: "(simpático)",
                options: [
                    { text: "simpatiquísimos", correct: true },
                    { text: "simpatiquísimo", correct: false, feedback: "¡Casi! 'Pingüinos' es plural." },
                    { text: "simpaticísimos", correct: false, feedback: "¡Ojo con la ortografía! La 'c' cambia a 'qu' delante de 'i'." },
                    { text: "simpatiquísimas", correct: false, feedback: "¡Casi! 'Pingüinos' es masculino." }
                ]
            },
            {
                id: 4,
                sentence: "El perro que encontró a su dueño está...",
                base: "(feliz)",
                options: [
                    { text: "felicísimo", correct: true },
                    { text: "felizísimo", correct: false, feedback: "¡Error de ortografía! La 'z' cambia a 'c' delante de 'i'." },
                    { text: "felicísima", correct: false, feedback: "Casi... pero 'perro' es masculino." },
                    { text: "felicísimos", correct: false, feedback: "Recuerda, 'el perro' es singular." }
                ]
            },
            // Adjetivos regulares
            {
                id: 5,
                sentence: "Buenos Aires es una ciudad...",
                base: "(famoso)",
                options: [
                    { text: "famosísima", correct: true },
                    { text: "famosísimo", correct: false, feedback: "¡Casi! 'Ciudad' es una palabra femenina." },
                    { text: "famosísimas", correct: false, feedback: "Recuerda, 'una ciudad' es singular." },
                    { text: "famoscísima", correct: false, feedback: "¡Ojo con la ortografía! 'Famoso' mantiene la 's'." }
                ]
            },
            {
                id: 6,
                sentence: "El Aconcagua es una montaña...",
                base: "(alto)",
                options: [
                    { text: "altísima", correct: true },
                    { text: "altísimo", correct: false, feedback: "Recuerda que 'montaña' es una palabra femenina." },
                    { text: "altísimas", correct: false, feedback: "Recuerda, 'una montaña' es singular." },
                    { text: "altoísima", correct: false, feedback: "¡Ojo! Solo se añade '-ísima' a la raíz." }
                ]
            },
            {
                id: 7,
                sentence: "Las empanadas son...",
                base: "(delicioso)",
                options: [
                    { text: "deliciosísimas", correct: true },
                    { text: "deliciosísimo", correct: false, feedback: "Casi... pero 'empanadas' es femenino y plural." },
                    { text: "deliciosísima", correct: false, feedback: "Casi... pero 'empanadas' es plural." },
                    { text: "deliciosísimos", correct: false, feedback: "Casi... pero 'empanadas' es femenino." }
                ]
            },
            {
                id: 8,
                sentence: "El Papa Francisco es...",
                base: "(popular)",
                options: [
                    { text: "popularísimo", correct: true },
                    { text: "popularísima", correct: false, feedback: "Casi... pero 'El Papa' es masculino." },
                    { text: "popularísimos", correct: false, feedback: "Recuerda, 'El Papa' es singular." },
                    { text: "populísimo", correct: false, feedback: "¡Casi! Se mantiene 'popular' como raíz." }
                ]
            },
            {
                id: 9,
                sentence: "Comprar cuero en Argentina es...",
                base: "(barato)",
                options: [
                    { text: "baratísimo", correct: true },
                    { text: "baratísima", correct: false, feedback: "Se trata la acción 'comprar' como algo neutro/masculino." },
                    { text: "baratoísimo", correct: false, feedback: "¡Ojo! Solo se añade '-ísimo' a la raíz." },
                    { text: "baratísimos", correct: false, feedback: "La acción 'comprar' es una sola cosa (singular)." }
                ]
            },
            {
                id: 10,
                sentence: "Vivir en la capital es...",
                base: "(caro)",
                options: [
                    { text: "carísimo", correct: true },
                    { text: "carísima", correct: false, feedback: "Se trata la acción 'vivir' como algo neutro/masculino." },
                    { text: "carosísimo", correct: false, feedback: "¡Ojo! Solo se añade '-ísimo' a la raíz." },
                    { text: "carísimim", correct: false, feedback: "La acción 'vivir' es una sola cosa (singular)." }
                ]
            },
            // Nuevos adjetivos simples
            {
                id: 11,
                sentence: "Las flores en Mendoza son...",
                base: "(bonito)",
                options: [
                    { text: "bonitísimas", correct: true },
                    { text: "bonitísimo", correct: false, feedback: "Recuerda, 'flores' es femenino y plural." },
                    { text: "bonitísima", correct: false, feedback: "Recuerda, 'flores' es plural." },
                    { text: "bonitísimos", correct: false, feedback: "Recuerda, 'flores' es femenino." }
                ]
            },
            {
                id: 12,
                sentence: "El Museo de La Boca es...",
                base: "(interesante)",
                options: [
                    { text: "interesantísimo", correct: true },
                    { text: "interesantísima", correct: false, feedback: "Casi... pero 'museo' es masculino." },
                    { text: "interesantísimos", correct: false, feedback: "Recuerda, 'El museo' es singular." },
                    { text: "interesanteísimo", correct: false, feedback: "¡Ojo! 'Interesante' pierde la 'e' final." }
                ]
            },
            {
                id: 13,
                sentence: "El tráfico en Buenos Aires es...",
                base: "(malo)",
                options: [
                    { text: "malísimo", correct: true },
                    { text: "malísima", correct: false, feedback: "Casi... pero 'tráfico' es masculino." },
                    { text: "malísimos", correct: false, feedback: "Recuerda, 'el tráfico' es singular." },
                    { text: "maloísimo", correct: false, feedback: "¡Ojo! Solo se añade '-ísimo' a la raíz." }
                ]
            },
            {
                id: 14,
                sentence: "Los jugadores de fútbol son...",
                base: "(rápido)",
                options: [
                    { text: "rapidísimos", correct: true },
                    { text: "rapidísimo", correct: false, feedback: "Recuerda, 'jugadores' es plural." },
                    { text: "rapidísima", correct: false, feedback: "Casi... pero 'jugadores' es masculino y plural." },
                    { text: "rapidísimas", correct: false, feedback: "Casi... pero 'jugadores' es masculino." }
                ]
            },
            {
                id: 15,
                sentence: "El viaje en bus a Patagonia es...",
                base: "(aburrido)",
                options: [
                    { text: "aburridísimo", correct: true },
                    { text: "aburridísima", correct: false, feedback: "Casi... pero 'viaje' es masculino." },
                    { text: "aburridísimos", correct: false, feedback: "Recuerda, 'el viaje' es singular." },
                    { text: "aburridoísimo", correct: false, feedback: "¡Ojo! Solo se añade '-ísimo' a la raíz." }
                ]
            },
            // Más práctica de las reglas
            {
                id: 16,
                sentence: "La nieve en Bariloche es...",
                base: "(blanco)",
                options: [
                    { text: "blanquísima", correct: true },
                    { text: "blancísima", correct: false, feedback: "¡Error de ortografía! La 'c' cambia a 'qu' delante de 'i'." },
                    { text: "blanquísimo", correct: false, feedback: "Casi... pero 'nieve' es femenino." },
                    { text: "blanquísimas", correct: false, feedback: "Recuerda, 'la nieve' es singular." }
                ]
            },
            {
                id: 17,
                sentence: "El aire en las montañas es...",
                base: "(fresco)",
                options: [
                    { text: "fresquísimo", correct: true },
                    { text: "frescísimo", correct: false, feedback: "¡Error de ortografía! La 'c' cambia a 'qu' delante de 'i'." },
                    { text: "fresquísima", correct: false, feedback: "Casi... pero 'aire' es masculino." },
                    { text: "fresquísimos", correct: false, feedback: "Recuerda, 'el aire' es singular." }
                ]
            },
            {
                id: 18,
                sentence: "La vida en el campo es...",
                base: "(lento)",
                options: [
                    { text: "lentísima", correct: true },
                    { text: "lentísimo", correct: false, feedback: "Casi... pero 'vida' es femenino." },
                    { text: "lentísimas", correct: false, feedback: "Recuerda, 'la vida' es singular." },
                    { text: "lentoísima", correct: false, feedback: "¡Ojo! Solo se añade '-ísima' a la raíz." }
                ]
            }
        ];
 
        // --- VARIABLES DEL JUEGO ---
        let playerName = "";
        let startTime, endTime, timerInterval;
        let gameRelativeSentences = [];
        let gameAbsoluteQuestions = [];
        let currentRelativeIndex = 0;
        let correctSlots = 0;
        
        // --- VARIABLES para el drag-and-drop HÍBRIDO ---
        let selectedTile = null; // Para 'dragstart' de mouse
        let isTouching = false;  // Flag para estado táctil
        let touchDraggedTile = null; // Elemento arrastrado con dedo
 
        // --- REFERENCIAS A ELEMENTOS DEL DOM ---
        const nameScreen = document.getElementById('name-screen');
        const relativeScreen = document.getElementById('relative-screen');
        const absoluteScreen = document.getElementById('absolute-screen');
        const successScreen = document.getElementById('success-screen');

        const playerNameInput = document.getElementById('player-name');
        const startGameBtn = document.getElementById('start-game-btn');

        const relativeProgress = document.getElementById('relative-progress');
        const relativeTimer = document.getElementById('relative-timer');
        const dropContainer = document.getElementById('drop-container');
        const dragContainer = document.getElementById('drag-container');
        const nextSentenceBtn = document.getElementById('next-sentence-btn');

        const absoluteQuestionsContainer = document.getElementById('absolute-questions-container');
        const submitAbsoluteBtn = document.getElementById('submit-absolute-btn');
 
        const successMessage = document.getElementById('success-message');
        const finalTime = document.getElementById('final-time');
        const screenshotBtn = document.getElementById('screenshot-btn');
        const screenshotFeedback = document.getElementById('screenshot-feedback');
        const restartGameBtn = document.getElementById('restart-game-btn');
 
        // --- LÓGICA DE NAVEGA CIÓN Y ESTADO ---
 
        startGameBtn.addEventListener('click', () => {
            playerName = playerNameInput.value.trim();
            if (playerName === "") {
                playerNameInput.classList.add('border-red-500', 'animate-pulse');
                playerNameInput.placeholder = "¡Por favor, escribe tu nombre!";
                setTimeout(() => {
                    playerNameInput.classList.remove('border-red-500', 'animate-pulse');
                    playerNameInput.placeholder = "Tu nombre";
                }, 2000);
                return;
            }
            
            // Inicializar juego
            gameRelativeSentences = shuffleArray(allRelativeSentences).slice(0, 6);
            gameAbsoluteQuestions = shuffleArray(allAbsoluteQuestions).slice(0, 6);
            currentRelativeIndex = 0;
            
            // Empezar temporizador
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);

            // Cambiar a la pantalla de relativos
            nameScreen.classList.add('hidden');
            relativeScreen.classList.remove('hidden');
            loadRelativeSentence(currentRelativeIndex);
        });
 
        function updateTimer() {
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            const minutes = String(Math.floor(diff / 60)).padStart(2, '0');
            const seconds = String(diff % 60).padStart(2, '0');
            
            if (relativeScreen.classList.contains('hidden')) {
                // No actualizar el timer si no estamos en la pantalla de relativos
                // El timer de la pantalla final es estático
            } else {
                 relativeTimer.textContent = `Tiempo: ${minutes}:${seconds}`;
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- LÓGICA - PARTE 1: SUPERLATIVOS RELATIVOS ---

        function loadRelativeSentence(index) {
            const sentence = gameRelativeSentences[index];
            const parts = sentence.parts;
            const shuffledParts = shuffleArray([...parts]);

            dropContainer.innerHTML = "";
            dragContainer.innerHTML = "";
            nextSentenceBtn.classList.add('hidden');
            correctSlots = 0;
            selectedTile = null;
            touchDraggedTile = null;
            isTouching = false;

            relativeProgress.textContent = `Oración ${index + 1} de 6`;

            // Crear slots para soltar
            parts.forEach((part, i) => {
                const slot = document.createElement('div');
                slot.id = `slot-${i}`;
                slot.dataset.correctText = part;
                slot.dataset.index = i;
                slot.className = "drop-slot w-auto h-12 flex-grow px-4 py-2 rounded-lg text-center text-lg font-medium text-gray-400";
                slot.textContent = `...`;
                
                // --- Eventos para MOUSE ---
                slot.addEventListener('dragover', onDragOver);
                slot.addEventListener('dragleave', onDragLeave);
                slot.addEventListener('drop', onDrop);
                
                dropContainer.appendChild(slot);
            });

            // Crear palabras para arrastrar
            shuffledParts.forEach((part, i) => {
                const tile = document.createElement('div');
                tile.id = `tile-${i}`;
                tile.dataset.text = part;
                tile.textContent = part;
                tile.className = "draggable bg-white px-5 py-3 rounded-lg shadow-md border border-gray-200 text-lg font-medium text-gray-700 hover:bg-gray-50 transition-all cursor-move";
                tile.draggable = true;

                // --- Eventos para MOUSE ---
                tile.addEventListener('dragstart', onDragStart);
                tile.addEventListener('dragend', onDragEnd);
                
                // --- Eventos para TÁCTIL ---
                tile.addEventListener('touchstart', onTouchDragStart, { passive: false });

                dragContainer.appendChild(tile);
            });
        }

        // --- FUNCIONES DE DRAG-AND-DROP (MOUSE) ---

        function onDragStart(e) {
            selectedTile = e.target; // Guardar el elemento
            e.dataTransfer.setData('text/plain', e.target.dataset.text);
            e.dataTransfer.setData('elementId', e.target.id);
            setTimeout(() => e.target.classList.add('selected'), 0); 
        }
        
        function onDragEnd(e) {
             if(selectedTile) selectedTile.classList.remove('selected');
             selectedTile = null;
        }

        function onDragOver(e) {
            e.preventDefault();
            if (e.target.classList.contains('drop-slot') && !e.target.classList.contains('correct')) {
                e.target.classList.add('drag-over');
            }
        }
        
        function onDragLeave(e) {
            if (e.target.classList.contains('drop-slot')) {
                e.target.classList.remove('drag-over');
            }
        }

        function onDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            const slot = e.target;
            
            const droppedText = e.dataTransfer.getData('text/plain');
            const elementId = e.dataTransfer.getData('elementId');
            const draggedElement = document.getElementById(elementId) || selectedTile; 
            
            checkMatch(slot, droppedText, draggedElement);
        }
        
        // --- FUNCIONES DE DRAG-AND-DROP (TÁCTIL) ---
        
        function onTouchDragStart(e) {
            e.preventDefault(); // Prevenir el scroll
            isTouching = true;
            touchDraggedTile = e.target;
            touchDraggedTile.classList.add('selected');
        }

        // Añadir listeners globales para mover y soltar (se añaden una vez al inicio)
        document.addEventListener('touchmove', onTouchDragMove, { passive: false });
        document.addEventListener('touchend', onTouchDragEnd);
        
        function onTouchDragMove(e) {
            if (!isTouching || !touchDraggedTile) return;
            
            e.preventDefault(); // Prevenir scroll mientras se arrastra
            
            const touch = e.touches[0];
            const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
            
            // Quitar resaltado de todos los slots
            dropContainer.querySelectorAll('.drop-slot').forEach(slot => {
                slot.classList.remove('drag-over');
            });
            
            if (elementUnder && elementUnder.classList.contains('drop-slot') && !elementUnder.classList.contains('correct')) {
                elementUnder.classList.add('drag-over');
            }
        }
        
        function onTouchDragEnd(e) {
            if (!isTouching || !touchDraggedTile) return;
            
            const touch = e.changedTouches[0];
            const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);

            // Quitar resaltado
            dropContainer.querySelectorAll('.drop-slot').forEach(slot => {
                slot.classList.remove('drag-over');
            });
            
            if (elementUnder && elementUnder.classList.contains('drop-slot')) {
                // Soltado sobre un slot
                checkMatch(elementUnder, touchDraggedTile.dataset.text, touchDraggedTile);
            }
            
            // Limpiar estado
            touchDraggedTile.classList.remove('selected');
            touchDraggedTile = null;
            isTouching = false;
        }

        // --- LÓGICA COMÚN DE VERIFICACIÓN ---
        
        function checkMatch(slot, text, tileElement) {
            // Evitar que un slot correcto sea sobrescrito
            if (slot.classList.contains('correct')) return;
            
            if (slot.dataset.correctText === text) {
                // ¡Correcto!
                slot.textContent = text;
                slot.classList.add('correct');
                
                if(tileElement) {
                    tileElement.classList.add('hidden'); // Ocultar la palabra arrastrada
                }
                
                correctSlots++;
                
                // Comprobar si la oración está completa
                if (correctSlots === gameRelativeSentences[currentRelativeIndex].parts.length) {
                    nextSentenceBtn.classList.remove('hidden');
                }
            } else {
                // Incorrecto
                slot.classList.add('animate-shake'); 
                setTimeout(() => slot.classList.remove('animate-shake'), 300);
            }
        }
 
        nextSentenceBtn.addEventListener('click', () => {
            currentRelativeIndex++;
            if (currentRelativeIndex < gameRelativeSentences.length) {
                loadRelativeSentence(currentRelativeIndex);
            } else {
                // Termina la Parte 1, empieza la Parte 2
                relativeScreen.classList.add('hidden');
                absoluteScreen.classList.remove('hidden');
                loadAbsoluteQuestions();
            }
        });

        // --- LÓGICA - PARTE 2: SUPERLATIVOS ABSOLUTOS ---
        
        function loadAbsoluteQuestions() {
            absoluteQuestionsContainer.innerHTML = "";
            gameAbsoluteQuestions.forEach((q, index) => {
                const questionCard = document.createElement('div');
                questionCard.id = `question-card-${q.id}`;
                questionCard.className = "question-card p-5 border border-gray-200 rounded-lg shadow-sm";
                
                let optionsHTML = "";
                const shuffledOptions = shuffleArray([...q.options]);
                
                shuffledOptions.forEach((opt, i) => {
                    optionsHTML += `
                        <label for="q${q.id}-opt${i}" class="radio-option block w-full p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                            <input type="radio" id="q${q.id}-opt${i}" name="question-${q.id}" value="${opt.text}" class="mr-3">
                            <span class="text-lg font-medium">${opt.text}</span>
                        </label>
                    `;
                });
                
                questionCard.innerHTML = `
                    <p class="text-lg font-medium text-gray-800 mb-4">
                        ${index + 1}. ${q.sentence} <span class="font-bold text-blue-600">${q.base}</span>
                    </p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        ${optionsHTML}
                    </div>
                    <div id="feedback-${q.id}" class="text-red-600 font-medium mt-3 text-sm hidden"></div>
                `;
                absoluteQuestionsContainer.appendChild(questionCard);
            });
        }
        
        submitAbsoluteBtn.addEventListener('click', () => {
            let allCorrect = true;
            
            // Resetear feedback
            document.querySelectorAll('.question-card').forEach(card => card.classList.remove('incorrect'));
            document.querySelectorAll('[id^="feedback-"]').forEach(fb => {
                fb.classList.add('hidden');
                fb.textContent = "";
            });
            
            gameAbsoluteQuestions.forEach(q => {
                const card = document.getElementById(`question-card-${q.id}`);
                const feedbackEl = document.getElementById(`feedback-${q.id}`);
                const selectedRadio = document.querySelector(`input[name="question-${q.id}"]:checked`);
                
                if (!selectedRadio) {
                    allCorrect = false;
                    card.classList.add('incorrect');
                    feedbackEl.textContent = "Por favor, elige una opción.";
                    feedbackEl.classList.remove('hidden');
                    return; // Siguiente pregunta
                }
                
                const selectedValue = selectedRadio.value;
                const selectedOption = q.options.find(opt => opt.text === selectedValue);
                
                if (!selectedOption.correct) {
                    allCorrect = false;
                    card.classList.add('incorrect');
                    feedbackEl.textContent = selectedOption.feedback;
                    feedbackEl.classList.remove('hidden');
                }
            });
            
            if (allCorrect) {
                // Terminar juego
                clearInterval(timerInterval);
                endTime = new Date();
                
                const totalSeconds = Math.floor((endTime - startTime) / 1000);
                const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                
                absoluteScreen.classList.add('hidden');
                successScreen.classList.remove('hidden');
                
                successMessage.textContent = `¡Felicidades, ${playerName}!`;
                finalTime.textContent = `Tiempo total: ${minutes}:${seconds}`;
            }
        });
        
        // --- LÓGICA - PANTALLA FINAL ---
        
        screenshotBtn.addEventListener('click', () => {
            screenshotFeedback.textContent = "Generando captura...";
            
            // Usar html2canvas para tomar la captura del 'game-container'
            html2canvas(document.getElementById('game-container'), {
                scale: 2 // Mejorar calidad
            }).then(canvas => {
                // Crear un enlace para descargar
                const link = document.createElement('a');
                link.download = `superlativos_completado_${playerName}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                screenshotFeedback.textContent = "¡Captura descargada!";
            }).catch(err => {
                console.error("Error con html2canvas: ", err);
                screenshotFeedback.textContent = "Error al generar. Usa el botón de captura de tu dispositivo.";
            });
        });

        restartGameBtn.addEventListener('click', () => {
            // Resetea el juego volviendo a la pantalla de inicio
            successScreen.classList.add('hidden');
            nameScreen.classList.remove('hidden');
            
            // Limpiar el nombre y el feedback
            playerNameInput.value = "";
            screenshotFeedback.textContent = "";
            
            // Limpiar el intervalo del timer si aún estuviera activo
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        });
 
    </script>
</body>
</html>



